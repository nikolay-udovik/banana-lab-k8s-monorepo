apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: infra-apps-helm
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - name: argocd
            chartRepoURL: 'https://argoproj.github.io/argo-helm'
            chartName: argo-cd
            chartVersion: 7.2.1
            valuesPath: kubernetes/apps/infra/argocd/local/values.yaml
            valuesPathDir: kubernetes/apps/infra/argocd/local
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: argocd

          - name: prometheus-stack
            chartRepoURL: 'https://prometheus-community.github.io/helm-charts'
            chartName: kube-prometheus-stack
            chartVersion: 67.5.0
            valuesPath: kubernetes/apps/infra/monitoring/kube-prometheus-stack/local/values.yaml
            valuesPathDir: kubernetes/apps/infra/monitoring/kube-prometheus-stack/local
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: monitoring

          - name: metrics-server
            chartRepoURL: 'https://kubernetes-sigs.github.io/metrics-server/'
            chartName: metrics-server
            chartVersion: 3.12.2
            valuesPath: kubernetes/apps/infra/kube-system/metrics-server/local/values.yaml
            valuesPathDir: kubernetes/apps/infra/kube-system/metrics-server/local
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: kube-system
  template:
    metadata:
      name: '{{name}}'
      labels:
        environment: local
        app-type: infra
    spec:
      project: default
      sources:
        - repoURL: '{{chartRepoURL}}'
          targetRevision: '{{chartVersion}}'
          chart: '{{chartName}}'
          helm:
            valueFiles:
              - '$values/{{valuesPath}}'
        - repoURL: 'https://github.com/nikolay-udovik/bringg-k8s-monorepo.git'
          targetRevision: master
          path: '{{valuesPathDir}}'
          ref: values
      destination:
        server: '{{destinationServer}}'
        namespace: '{{destinationNamespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true

---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: infra-apps-non-helm
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          # - name: all-in-one
          #   repoURL: 'https://github.com/nikolay-udovik/bringg-k8s-monorepo.git'
          #   path: kubernetes/argocd/local
          #   targetRevision: master
          #   destinationServer: "https://kubernetes.default.svc"
          #   destinationNamespace: argocd

          - name: ingress-nginx
            repoURL: 'https://github.com/kubernetes/ingress-nginx.git'
            path: deploy/static/provider/kind
            targetRevision: HEAD
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: ingress-nginx
  template:
    metadata:
      name: '{{name}}'
      labels:
        environment: local
        app-type: infra
    spec:
      project: default
      source:
        repoURL: '{{repoURL}}'
        targetRevision: '{{targetRevision}}'
        path: '{{path}}'
      destination:
        server: '{{destinationServer}}'
        namespace: '{{destinationNamespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true

---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: workload-apps
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - name: podinfo
            repoURL: 'https://github.com/stefanprodan/podinfo.git'
            path: kustomize
            targetRevision: master
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: demo
            
          - name: podinfo-token-validator
            repoURL: 'https://github.com/nikolay-udovik/bringg-podinfo-token-validator.git'
            path: kubernetes/overlays/local
            targetRevision: main
            destinationServer: "https://kubernetes.default.svc"
            destinationNamespace: demo
  template:
    metadata:
      name: '{{name}}'
      labels:
        environment: local
        app-type: application-layer
    spec:
      project: default
      source:
        repoURL: '{{repoURL}}'
        targetRevision: '{{targetRevision}}'
        path: '{{path}}'
      destination:
        server: '{{destinationServer}}'
        namespace: '{{destinationNamespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true